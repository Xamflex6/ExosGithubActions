name: build-and-push-docker

on:
  push:
    branches:
      - main # ðŸŽ¯ 1. DÃ©clencheur : on: push main:
      
env:
  DOCKER_IMAGE_NAME: Workflow Java
  DOCKER_HUB_USERNAME: xamflex6
  JAVA_VERSION: '17' 
  
jobs:
  build_deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
      
      # --- Ã‰tape 1 : PrÃ©paration et Compilation ---
      
      - name: Configuration du JDK ${{ env.JAVA_VERSION }} # ðŸŽ¯ 2. install jdk
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          
      - name: Compilation avec Maven (ou Gradle) # ðŸŽ¯ 3. compiler le projet
        run: mvn clean package -DskipTests 

      # --- Ã‰tape 2 : Configuration Docker ---
      
      - name: RÃ©cupÃ©ration du SHA court pour le tag de l'image
        id: docker_tag
        run: echo "SHA_SHORT=$(echo $GITHUB_SHA | cut -c1-8)" >> $GITHUB_OUTPUT
      
      - name: Connexion Ã  Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }} 
          
      # --- Ã‰tape 3 & 4 : Build et Push ---
      
      - name: Construction des images Docker et Push # ðŸŽ¯ 4. Utiliser docker, Faire les images, ðŸŽ¯ 5. Push sur docker hub
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_HUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:latest
            ${{ env.DOCKER_HUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ steps.docker_tag.outputs.SHA_SHORT }}
